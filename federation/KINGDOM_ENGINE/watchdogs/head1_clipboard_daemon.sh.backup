#!/data/data/com.termux/files/usr/bin/bash
# HEAD 1 â€“ CLIPBOARD DAEMON (Gabriel-Announce)
# INTEGRATION: Checks Covenant Axioms instantly upon ingestion.

LOG=~/KINGDOM_ENGINE/logs/head1_clipboard.log
INBOX=~/KINGDOM_ENGINE/MEGA/inbox/head1
COVENANT_CHECK=~/KINGDOM_ENGINE/analyzers/covenant_engine.py

mkdir -p "$INBOX"

while true; do
    NEW=$(termux-clipboard-get 2>/dev/null || echo "")
    if [ "$NEW" != "$LAST" ] && [ -n "$NEW" ]; then
        
        TS=$(date --iso-8601=seconds)
        ID=$(date +%s%N)
        
        # 1. RUN AXIOM CHECK: Exit code 1 means VIOLATION
        echo "$NEW" | python3 "$COVENANT_CHECK" >/dev/null 2>&1
        EXIT_CODE=$?
        
        if [ $EXIT_CODE -ne 0 ]; then
            STATUS="AXIOM_VIOLATION"
            echo "[$(date --iso-8601=seconds)] WARNING | CLIPBOARD | VIOLATION DETECTED." >> "$LOG"
        else
            STATUS="AXIOM_CLEAN"
        fi
        
        # 2. CREATE PAYLOAD
        SAFE_CONTENT=$(echo "$NEW" | tr -d '\n\r' | sed 's/\\/\\\\/g; s/"/\\"/g')
        cat > "$INBOX/$ID.json" <<EOF
{
  "id": "$ID",
  "timestamp": "$TS",
  "source": "clipboard",
  "status": "$STATUS",
  "payload": "$SAFE_CONTENT"
}
EOF
        echo "$TS | CLIPBOARD | $STATUS | Payload ID: $ID" >> "$LOG"
        LAST="$NEW"
    fi
    sleep 1
done
